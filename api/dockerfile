# ── STEP 1: Use a CPU-only, ARM-compatible base image with Python ───────────────
FROM python:3.10-slim

# ── STEP 2: System dependencies (minimal set) ───────────────────────────────────
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libgl1-mesa-glx \
    && rm -rf /var/lib/apt/lists/*

# ── STEP 3: Set work directory ──────────────────────────────────────────────────
WORKDIR /app

# ── STEP 4: Copy requirements and install dependencies ──────────────────────────
COPY requirements.txt .
RUN pip install --upgrade pip && pip install -r requirements.txt

# ── STEP 5: Copy app code and model weights ─────────────────────────────────────
COPY app.py .
COPY stool_model.pth .

# ── STEP 6: Expose port and run server ──────────────────────────────────────────
EXPOSE 8000
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]